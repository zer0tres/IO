<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Remoto - Estufa Automatizada</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .status-geral {
            font-size: 1.2em;
            color: #7f8c8d;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #3498db;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card.alert {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }
        
        .card-title {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            font-size: 1.2em;
        }
        
        .card-value {
            font-size: 2.8em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .card-value.boa { color: #27ae60; }
        .card-value.atencao { color: #f39c12; }
        .card-value.alerta { color: #e74c3c; }
        
        .card-unit {
            font-size: 1em;
            color: #7f8c8d;
            margin-left: 5px;
        }
        
        .card-desc {
            font-size: 0.9em;
            color: #95a5a6;
            margin-top: 10px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .status-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #eee;
        }
        
        .status-item.ligado {
            background: #d5f4e6;
            border-color: #27ae60;
        }
        
        .status-item.desligado {
            background: #f5f5f5;
            border-color: #bdc3c7;
        }
        
        .status-label {
            font-size: 1em;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status-value {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .status-value.ligado { color: #27ae60; }
        .status-value.desligado { color: #7f8c8d; }
        
        .alerta-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            display: none;
        }
        
        .alerta-box.ativo {
            display: block;
            animation: pulse 2s infinite;
        }
        
        .alerta-titulo {
            color: #856404;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alerta-mensagem {
            color: #856404;
            font-size: 1.1em;
        }
        
        .conexao-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 1000;
        }
        
        .conexao-status.online {
            background: #27ae60;
            color: white;
        }
        
        .conexao-status.offline {
            background: #e74c3c;
            color: white;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .card-value {
                font-size: 2.2em;
            }
        }
        
        .ultima-atualizacao {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="conexao-status offline" id="statusConexao">
        üî¥ DESCONECTADO
    </div>
    
    <div class="container">
        <header>
            <h1>üåø Monitoramento Remoto - Estufa Automatizada</h1>
            <p class="status-geral">Sistema baseado em ESP32-S3 | Tempo real via MQTT</p>
        </header>
        
        <div class="dashboard">
            <!-- Temperatura -->
            <div class="card" id="card-temp">
                <div class="card-title">üå°Ô∏è Temperatura Ambiente</div>
                <div class="card-value" id="valor-temp">--</div>
                <div class="card-desc">Ideal: 18-28¬∞C | Atual: <span id="hora-atual">--:--</span></div>
            </div>
            
            <!-- Umidade do Ar -->
            <div class="card" id="card-hum-ar">
                <div class="card-title">üíß Umidade do Ar</div>
                <div class="card-value" id="valor-hum-ar">--</div>
                <div class="card-desc">Ideal: 40-70%</div>
            </div>
            
            <!-- Umidade do Solo -->
            <div class="card" id="card-hum-solo">
                <div class="card-title">üå± Umidade do Solo</div>
                <div class="card-value" id="valor-hum-solo">--</div>
                <div class="card-desc">Percentual de satura√ß√£o</div>
            </div>
        </div>
        
        <div class="status-grid">
            <!-- Status da Ilumina√ß√£o -->
            <div class="status-item" id="status-luz">
                <div class="status-label">üí° Ilumina√ß√£o</div>
                <div class="status-value" id="valor-luz">--</div>
                <div class="card-desc">Intensidade: <span id="intensidade-luz">--</span></div>
            </div>
            
            <!-- Status da Bomba -->
            <div class="status-item" id="status-bomba">
                <div class="status-label">üíß Bomba de √Ågua</div>
                <div class="status-value" id="valor-bomba">--</div>
            </div>
            
            <!-- Status Ventoinhas -->
            <div class="status-item" id="status-ventoinhas">
                <div class="status-label">üåÄ Ventoinhas</div>
                <div class="status-value" id="valor-ventoinhas">--</div>
            </div>
            
            <!-- Status Exaustor -->
            <div class="status-item" id="status-exaustor">
                <div class="status-label">üå¨Ô∏è Exaustor</div>
                <div class="status-value" id="valor-exaustor">--</div>
            </div>
        </div>
        
        <!-- Alertas -->
        <div class="alerta-box" id="alerta-box">
            <div class="alerta-titulo">‚ö†Ô∏è ATEN√á√ÉO</div>
            <div class="alerta-mensagem" id="alerta-mensagem">Nenhum alerta no momento</div>
        </div>
        
        <div class="ultima-atualizacao">
            √öltima atualiza√ß√£o: <span id="ultima-atualizacao">--:--:--</span>
        </div>
    </div>

    <script>
        // Configura√ß√£o MQTT
        const brokerUrl = "wss://test.mosquitto.org:8081";
        const topicos = {
            temperatura: "estufa/joao/temperatura",
            umidadeAr: "estufa/joao/umidade_ar",
            umidadeSolo: "estufa/joao/umidade_solo",
            soloPorcent: "estufa/joao/solo_porcentagem",
            bomba: "estufa/joao/status_bomba",
            luz: "estufa/joao/status_luz",
            ventoinhas: "estufa/joao/status_ventoinhas",
            exaustor: "estufa/joao/status_exaustor",
            intensidade: "estufa/joao/intensidade_luz",
            hora: "estufa/joao/hora_sistema",
            alertas: "estufa/joao/alertas"
        };

        // Elementos da p√°gina
        const elementos = {
            temp: document.getElementById('valor-temp'),
            humAr: document.getElementById('valor-hum-ar'),
            humSolo: document.getElementById('valor-hum-solo'),
            luz: document.getElementById('valor-luz'),
            bomba: document.getElementById('valor-bomba'),
            ventoinhas: document.getElementById('valor-ventoinhas'),
            exaustor: document.getElementById('valor-exaustor'),
            intensidadeLuz: document.getElementById('intensidade-luz'),
            horaAtual: document.getElementById('hora-atual'),
            alertaBox: document.getElementById('alerta-box'),
            alertaMsg: document.getElementById('alerta-mensagem'),
            statusConexao: document.getElementById('statusConexao'),
            ultimaAtualizacao: document.getElementById('ultima-atualizacao')
        };

        // Cards para colora√ß√£o din√¢mica
        const cards = {
            temp: document.getElementById('card-temp'),
            humAr: document.getElementById('card-hum-ar'),
            humSolo: document.getElementById('card-hum-solo')
        };

        let client = null;
        let ultimaAtualizacao = new Date();

        // Conectar ao broker MQTT
        function conectarMQTT() {
            console.log("Conectando ao broker MQTT...");
            
            client = mqtt.connect(brokerUrl);
            
            client.on('connect', () => {
                console.log("‚úÖ Conectado ao broker MQTT");
                elementos.statusConexao.textContent = "üü¢ CONECTADO";
                elementos.statusConexao.className = "conexao-status online";
                
                // Inscrever em todos os t√≥picos
                Object.values(topicos).forEach(topico => {
                    client.subscribe(topico, (err) => {
                        if (!err) console.log(`Inscrito em: ${topico}`);
                    });
                });
            });
            
            client.on('message', (topic, message) => {
                const valor = message.toString();
                console.log(`üì© ${topic}: ${valor}`);
                
                ultimaAtualizacao = new Date();
                elementos.ultimaAtualizacao.textContent = 
                    `${ultimaAtualizacao.getHours().toString().padStart(2, '0')}:` +
                    `${ultimaAtualizacao.getMinutes().toString().padStart(2, '0')}:` +
                    `${ultimaAtualizacao.getSeconds().toString().padStart(2, '0')}`;
                
                // Processar mensagens
                switch(topic) {
                    case topicos.temperatura:
                        elementos.temp.textContent = `${valor}¬∞C`;
                        atualizarCorTemperatura(parseFloat(valor));
                        break;
                        
                    case topicos.umidadeAr:
                        elementos.humAr.textContent = `${valor}%`;
                        atualizarCorUmidadeAr(parseFloat(valor));
                        break;
                        
                    case topicos.soloPorcent:
                        elementos.humSolo.textContent = `${valor}%`;
                        atualizarCorUmidadeSolo(parseInt(valor));
                        break;
                        
                    case topicos.bomba:
                        elementos.bomba.textContent = valor;
                        atualizarStatus('bomba', valor);
                        break;
                        
                    case topicos.luz:
                        elementos.luz.textContent = valor;
                        atualizarStatus('luz', valor);
                        break;
                        
                    case topicos.ventoinhas:
                        elementos.ventoinhas.textContent = valor;
                        atualizarStatus('ventoinhas', valor);
                        break;
                        
                    case topicos.exaustor:
                        elementos.exaustor.textContent = valor;
                        atualizarStatus('exaustor', valor);
                        break;
                        
                    case topicos.intensidade:
                        elementos.intensidadeLuz.textContent = `${valor}/255`;
                        break;
                        
                    case topicos.hora:
                        elementos.horaAtual.textContent = valor;
                        break;
                        
                    case topicos.alertas:
                        if (valor !== "Tudo normal") {
                            elementos.alertaBox.classList.add('ativo');
                            elementos.alertaMsg.textContent = valor;
                        } else {
                            elementos.alertaBox.classList.remove('ativo');
                        }
                        break;
                }
            });
            
            client.on('error', (err) => {
                console.error("Erro MQTT:", err);
                elementos.statusConexao.textContent = "üî¥ ERRO DE CONEX√ÉO";
                elementos.statusConexao.className = "conexao-status offline";
            });
            
            client.on('close', () => {
                console.log("Conex√£o MQTT fechada");
                elementos.statusConexao.textContent = "üî¥ DESCONECTADO";
                elementos.statusConexao.className = "conexao-status offline";
            });
        }

        // Fun√ß√µes de atualiza√ß√£o de cores e status
        function atualizarCorTemperatura(temp) {
            if (temp < 18) {
                cards.temp.classList.add('atencao');
                cards.temp.classList.remove('alerta', 'boa');
            } else if (temp > 28) {
                cards.temp.classList.add('alerta');
                cards.temp.classList.remove('atencao', 'boa');
            } else {
                cards.temp.classList.add('boa');
                cards.temp.classList.remove('atencao', 'alerta');
            }
        }

        function atualizarCorUmidadeAr(umid) {
            if (umid < 40 || umid > 70) {
                cards.humAr.classList.add('atencao');
                cards.humAr.classList.remove('boa');
            } else {
                cards.humAr.classList.add('boa');
                cards.humAr.classList.remove('atencao');
            }
        }

        function atualizarCorUmidadeSolo(porcent) {
            if (porcent < 30) {
                cards.humSolo.classList.add('alerta');
                cards.humSolo.classList.remove('atencao', 'boa');
            } else if (porcent < 50) {
                cards.humSolo.classList.add('atencao');
                cards.humSolo.classList.remove('alerta', 'boa');
            } else if (porcent < 80) {
                cards.humSolo.classList.add('boa');
                cards.humSolo.classList.remove('atencao', 'alerta');
            } else {
                cards.humSolo.classList.add('alerta');
                cards.humSolo.classList.remove('atencao', 'boa');
            }
        }

        function atualizarStatus(tipo, valor) {
            const elemento = document.getElementById(`status-${tipo}`);
            const valorElemento = document.getElementById(`valor-${tipo}`);
            
            if (valor === 'LIGADA' || valor === 'LIGADAS' || valor === 'LIGADO') {
                elemento.classList.add('ligado');
                elemento.classList.remove('desligado');
                valorElemento.classList.add('ligado');
                valorElemento.classList.remove('desligado');
            } else {
                elemento.classList.add('desligado');
                elemento.classList.remove('ligado');
                valorElemento.classList.add('desligado');
                valorElemento.classList.remove('ligado');
            }
        }

        // Reconectar automaticamente
        function verificarConexao() {
            if (!client || !client.connected) {
                console.log("Reconectando...");
                conectarMQTT();
            }
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            conectarMQTT();
            
            // Verificar conex√£o a cada 30 segundos
            setInterval(verificarConexao, 30000);
            
            // Atualizar hora da p√°gina
            setInterval(() => {
                const agora = new Date();
                if (client && client.connected) {
                    elementos.ultimaAtualizacao.textContent = 
                        `${agora.getHours().toString().padStart(2, '0')}:` +
                        `${agora.getMinutes().toString().padStart(2, '0')}:` +
                        `${agora.getSeconds().toString().padStart(2, '0')}`;
                }
            }, 1000);
        });

        // Para acesso mobile
        window.addEventListener('offline', () => {
            elementos.statusConexao.textContent = "üî¥ SEM INTERNET";
            elementos.statusConexao.className = "conexao-status offline";
        });
        
        window.addEventListener('online', () => {
            elementos.statusConexao.textContent = "üü¢ RECONECTANDO...";
            elementos.statusConexao.className = "conexao-status online";
            verificarConexao();
        });
    </script>
</body>
</html>